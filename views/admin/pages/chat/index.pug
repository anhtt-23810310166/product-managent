extends ../../layouts/default.pug
include ../../mixins/page-header.pug

block main
  +pageHeader("Chat Hỗ Trợ", "Hộp thư chăm sóc khách hàng")

  .row.chat-admin-container
    // Danh sách Khách Hàng (Trái)
    .col-md-4.chat-admin-sidebar
      .card.shadow-sm
        .card-header.bg-primary.text-white
          h5.mb-0 
            i.fas.fa-inbox.mr-2
            | Khách hàng cần hỗ trợ
        .card-body.p-0(style="max-height: 600px; overflow-y: auto;")
          ul.list-group.list-group-flush.chat-room-list
            if roomChats && roomChats.length > 0
              each room in roomChats
                a.list-group-item.list-group-item-action(href=`${prefixAdmin}/chat/${room.id}` class=(activeRoom && activeRoom.id === room.id ? "active bg-light" : ""))
                  .d-flex.align-items-center
                    if room.user_id && room.user_id.avatar
                      img.rounded-circle.mr-3(src=room.user_id.avatar width="45" height="45" style="object-fit: cover; border: 1px solid #ddd;")
                    else
                      .rounded-circle.bg-secondary.text-white.d-flex.align-items-center.justify-content-center.mr-3(style="width: 45px; height: 45px;")
                        i.fas.fa-user
                    .room-info.flex-grow-1
                      .d-flex.align-items-center.justify-content-between
                        h6.mb-1.font-weight-bold= room.user_id ? room.user_id.fullName : "Khách ẩn danh"
                        if room.user_id
                          span(data-sidebar-userid=room.user_id.id)
                            if room.user_id.statusOnline
                              i.fas.fa-circle.text-success(style="font-size: 10px;" title="Online")
                            else
                              i.fas.fa-circle.text-muted(style="font-size: 10px;" title="Offline")
                      small.text-muted Bấm để hỗ trợ ngay
            else
              .p-4.text-center.text-muted
                i.fas.fa-check-circle.fa-2x.mb-2.text-success
                p.mb-0 Chưa có yêu cầu trống nào

    // Khung Chat Chi Tiết (Phải)
    .col-md-8.chat-admin-main
      if activeRoom
        .card.shadow-sm.chat-admin-card
          .card-header.bg-white.d-flex.align-items-center.justify-content-between.border-bottom
            .d-flex.align-items-center
              if activeRoom.user_id && activeRoom.user_id.avatar
                img.rounded-circle.mr-3(src=activeRoom.user_id.avatar width="45" height="45" style="object-fit: cover;")
              else
                .rounded-circle.bg-secondary.text-white.d-flex.align-items-center.justify-content-center.mr-3(style="width: 45px; height: 45px;")
                  i.fas.fa-user
              div
              div
                h5.mb-0= activeRoom.user_id ? activeRoom.user_id.fullName : "Khách ẩn danh"
                if activeRoom.user_id
                  if activeRoom.user_id.statusOnline
                    small.text-success(data-status-userid=activeRoom.user_id.id)
                      i.fas.fa-circle.mr-1(style="font-size: 8px;")
                      | Đang trực tuyến
                  else
                    small.text-muted(data-status-userid=activeRoom.user_id.id)
                      i.fas.fa-circle.mr-1(style="font-size: 8px;")
                      | Ngoại tuyến
            div
              button.btn.btn-sm.btn-outline-secondary(style="border-radius: 20px;")
                i.fas.fa-info-circle.mr-1
                | Lịch sử mua

          .card-body.chat-admin-body#chatBody(style="height: 400px; overflow-y: auto; background-color: #f0f2f5;")
            if chats && chats.length > 0
              each chat in chats
                if chat.sender_type === "admin"
                  // Bọt thoại Admin
                  .d-flex.justify-content-end.mb-3.chat-message.chat-message-self(data-sender-id=chat.sender_id)
                    .bg-primary.text-white.p-2.shadow-sm(style="border-radius: 15px; max-width: 75%; border-top-right-radius: 0 !important;")
                      p.mb-1(style="word-wrap: break-word; font-size: 14px;")= chat.content
                      if chat.images && chat.images.length > 0
                        .chat-mb-images.mt-2
                          each img in chat.images
                            a(href=img target="_blank")
                              img.img-thumbnail.mr-1(src=img height="60" style="object-fit: scale-down; max-width: 100px;")
                      small.text-white-50.d-block.text-right(style="font-size: 0.75rem;")= new Date(chat.createdAt).toLocaleTimeString("vi-VN", { hour: "2-digit", minute: "2-digit" })
                
                else if chat.sender_type === "user"
                  // Bọt thoại Khách hàng
                  .d-flex.justify-content-start.mb-3.chat-message.chat-message-other(data-sender-id=chat.sender_id)
                    if activeRoom.user_id && activeRoom.user_id.avatar
                      img.rounded-circle.mr-2(src=activeRoom.user_id.avatar width="32" height="32" style="object-fit:cover")
                    else
                      .rounded-circle.bg-secondary.text-white.d-flex.align-items-center.justify-content-center.mr-2(style="width: 32px; height: 32px;")
                        i.fas.fa-user.fa-sm
                    .bg-white.p-2.shadow-sm.border(style="border-radius: 15px; max-width: 75%; border-top-left-radius: 0 !important;")
                      p.mb-1(style="word-wrap: break-word; color: #1c1e21; font-size: 14px;")= chat.content
                      if chat.images && chat.images.length > 0
                        .chat-mb-images.mt-2
                          each img in chat.images
                            a(href=img target="_blank")
                              img.img-thumbnail.mr-1(src=img height="60" style="object-fit: scale-down; max-width: 100px;")
                      small.text-muted.d-block(style="font-size: 0.75rem;")= new Date(chat.createdAt).toLocaleTimeString("vi-VN", { hour: "2-digit", minute: "2-digit" })
            else
              .text-center.text-muted.mt-5.chat-empty
                i.far.fa-comment-dots.fa-3x.mb-3
                p Hãy gửi lời chào đến Khách hàng

          .card-footer(style="background-color: #f0f2f5; border: none;")
            .chat-typing#chatTyping.mb-2(style="display: none;")
              small.text-muted
                i.fas.fa-ellipsis-h.fa-beat.mr-1
                | Khách hàng đang nhập văn bản...
                  
            form#chatForm.d-flex.align-items-center
              input(type="hidden" id="roomChatId" value=activeRoom.id)
              input.form-control.mr-2#chatInput(type="text" placeholder="Nhập câu trả lời cho khách..." autocomplete="off" style="font-size: 14px;")
              button.btn.btn-primary.px-4(type="submit" style="font-size: 14px;" title="Gửi")
                i.fas.fa-paper-plane
      else
        .card.shadow-sm.h-100.d-flex.align-items-center.justify-content-center(style="min-height: 600px; background-color: #f8f9fa;")
          .text-center.text-muted
            i.fas.fa-comments.fa-4x.mb-3.text-light
            h4 Chọn một khách hàng để bắt đầu chat

  //- Thư viện Socket JS cho Admin
  script(src="/socket.io/socket.io.js")
  script(src="/admin/js/chat.js")
