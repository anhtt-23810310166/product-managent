html
  head
    title= title
    meta(name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no")
    link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous")
    link(rel="stylesheet", href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css")
    link(rel="preconnect" href="https://fonts.googleapis.com")
    link(rel="preconnect" href="https://fonts.gstatic.com" crossorigin)
    link(rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap")
    link(rel="stylesheet", href=`/client/css/style.css?v=${Date.now()}`)
    //- CSS Thư viện Upload cho Widget Chat
    link(rel="stylesheet" type="text/css" href="https://unpkg.com/file-upload-with-preview/dist/style.css")
  body
    if (clientUser)
      span.d-none#myUserId(data-id=clientUser.id)
      
    include ../partials/header.pug

    //- Flash messages + Toast container
    #toastContainer.toast-container
      if messages.success && messages.success.length > 0
        each msg in messages.success
          .toast-notification.toast-success.show
            i.fas.fa-check-circle.toast-icon
            span.toast-message= msg
            button.toast-close(type="button") &times;
      if messages.error && messages.error.length > 0
        each msg in messages.error
          .toast-notification.toast-error.show
            i.fas.fa-exclamation-circle.toast-icon
            span.toast-message= msg
            button.toast-close(type="button") &times;

    block main

    include ../partials/footer.pug

    //- Widget Chat Nổi (Luôn hiện bong bóng)
    .chat-widget-trigger#chatWidgetTrigger
      i.fas.fa-comments
      span.chat-badge.d-none 0
      
    .chat-widget-box#chatWidgetBox.d-none
      .chat-widget-header
        span 
          i.fas.fa-headset.mr-2
          | Trò chuyện cùng Shop
        button.chat-widget-close#chatWidgetClose &times;

      if clientUser
        .chat-widget-body#chatBody
          .chat-loading.text-center.my-3
            i.fas.fa-spinner.fa-spin.text-primary

        //- Emoji picker (Web Component) ẩn
        .emoji-picker#emojiPicker
          emoji-picker.light
        
        //- Khung Preview Hình ảnh Widget
        .chat-image-preview
          .custom-file-container(data-upload-id="chat-upload")

        .chat-widget-footer
          form#chatForm.chat-form.m-0
            input(type="hidden" id="chatUserId" value=clientUser._id)
            input(type="hidden" id="chatUserName" value=clientUser.fullName)
            .chat-input-wrap.d-flex.align-items-center
              button.chat-emoji-btn(type="button" id="emojiBtn" title="Emoji")
                i.far.fa-smile
              label.chat-image-btn.mb-0(for="file-upload-with-preview-chat-upload" title="Gửi file/ảnh")
                i.fas.fa-paperclip
              input.chat-input.flex-grow-1(type="text" id="chatInput" placeholder="Nhập tin nhắn..." autocomplete="off")
              button.chat-send-btn(type="submit" title="Gửi")
                i.fas.fa-paper-plane
              input(type="file" class="custom-file-container__custom-file__custom-file-input" id="file-upload-with-preview-chat-upload" multiple style="display: none;")
      else
        .chat-widget-body.d-flex.align-items-center.justify-content-center(style="background-color: white;")
          .text-center.p-3
            i.fas.fa-lock.fa-3x.text-muted.mb-3
            h6(style="color: var(--shopee-text);") Đăng nhập để nhắn tin
            p.text-muted(style="font-size: 13px;") Vui lòng đăng nhập tài khoản để được đội ngũ CSKH hỗ trợ tốt nhất.
            a.btn.btn-primary.btn-sm.btn-block.mb-2(href="/user/login") Đăng nhập
            a.btn.btn-outline-primary.btn-sm.btn-block(href="/user/register") Đăng ký mở tài khoản

    //- Thư viện JS Widget Chat (Luôn được load để xử lý đóng mở bong bóng)
    if clientUser
      script(src="https://unpkg.com/file-upload-with-preview/dist/file-upload-with-preview.iife.js")
      script(type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.22.8/index.js")
    script(type="module" src="/client/js/widget-chat.js")

    script(src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous")
    script(src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct" crossorigin="anonymous")
    
    //- Socket.IO Global
    script(src="/socket.io/socket.io.js")
    script(src="/client/js/script.js")