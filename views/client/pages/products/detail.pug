extends ../../layouts/default

block main
  .container.py-4
    //- Breadcrumb
    nav(aria-label="breadcrumb")
      ol.breadcrumb.bg-transparent.px-0.pb-3.pt-0.mb-0.tz-breadcrumb-nav
        li.breadcrumb-item
          a.text-muted(href="/") Trang chủ
        li.breadcrumb-item
          a.text-muted(href="/products") Sản phẩm
        li.breadcrumb-item.active.tz-breadcrumb-active(aria-current="page")= product.title

    //- Product Detail Card
    .card.border-0.shadow-sm.overflow-hidden.mb-5.tz-detail-card
      .row.no-gutters.p-3
        //- Product Image Gallery (Shopee-style)
        .col-lg-5.col-md-6.mb-4.mb-md-0
          .tz-gallery
            .tz-gallery-main.position-relative
              if product.discountPercentage && product.discountPercentage > 0
                .badge.badge-danger.position-absolute.tz-badge-discount-lg 
                  | -#{product.discountPercentage}%
              if product.thumbnail
                img.tz-gallery-main-img#galleryMainImg(src=product.thumbnail alt=product.title)
              else
                .py-5.text-muted.text-center
                  i.fas.fa-image.fa-4x.mb-3
                  p Chưa có ảnh
            
            //- Thumbnail Strip
            - var allImages = [product.thumbnail].concat(product.images || []).filter(Boolean)
            if allImages.length > 1
              .tz-gallery-thumbs
                each img, idx in allImages
                  .tz-gallery-thumb(class=(idx === 0 ? "active" : "") onclick="changeGalleryImage(this, '" + img + "')")
                    img(src=img alt=`Ảnh ${idx + 1}`)

        //- Product Info
        .col-lg-7.col-md-6.pl-md-5
          h1.font-weight-bold.mb-3.tz-product-title-lg= product.title
          
          .d-flex.align-items-center.mb-4
            .d-flex.text-warning.mr-3.tz-stars-lg
              - for (var i = 1; i <= 5; i++)
                if i <= Math.round(averageRating)
                  i.fas.fa-star
                else
                  i.fas.fa-star.text-muted
            if reviewCount > 0
              span.text-muted.mr-3.tz-rating-text #{averageRating}/5 (#{reviewCount} đánh giá)
            else
              span.text-muted.mr-3.tz-rating-text (Chưa có đánh giá)
            span.text-muted.tz-rating-text | Đã bán 0

          //- Price
          .p-3.mb-4.tz-price-box
            if product.discountPercentage && product.discountPercentage > 0
              - var discountedPrice = Math.round(product.price * (1 - product.discountPercentage / 100))
              .d-flex.align-items-end
                .font-weight-bold.mr-3.tz-price-current-lg= discountedPrice.toLocaleString('vi-VN') + '₫'
                .text-muted.mb-1.tz-price-old-lg= product.price.toLocaleString('vi-VN') + '₫'
              .mt-1
                span.badge.badge-success.font-weight-normal.tz-badge-saving
                  | Tiết kiệm: #{(product.price - discountedPrice).toLocaleString('vi-VN')}₫
            else
              .font-weight-bold.tz-price-current-lg= product.price ? product.price.toLocaleString('vi-VN') + '₫' : 'Liên hệ'

          //- Stock
          .mb-3.tz-stock-status
            span.text-muted.mr-3 Trạng thái:
            if product.stock > 10
              span.tz-text-success-bold
                i.fas.fa-check-circle.mr-1
                | Còn hàng (#{product.stock})
            else if product.stock > 0
              span.font-weight-bold.text-warning
                i.fas.fa-exclamation-triangle.mr-1
                | Sắp hết (#{product.stock})
            else
              span.font-weight-bold.text-danger
                i.fas.fa-times-circle.mr-1
                | Hết hàng

          //- Brand
          if brand
            .mb-4.tz-stock-status
              span.text-muted.mr-3 Thương hiệu:
              .d-inline-flex.align-items-center.tz-brand-badge
                if brand.logo
                  img.tz-brand-logo(src=brand.logo alt=brand.name)
                span.font-weight-bold.tz-brand-name= brand.name

          //- Divider
          hr.my-4

          //- Thêm vào giỏ hàng
          if product.stock > 0
            form(action=`/cart/add/${product._id}` method="POST")
              .d-flex.align-items-center.mb-4
                span.text-muted.mr-4.tz-quantity-label Số lượng:
                .input-group.tz-quantity-input-group
                  .input-group-prepend
                    button.btn.btn-light.px-3.tz-quantity-btn(type="button" onclick="this.parentNode.nextElementSibling.stepDown()") -
                  input.form-control.text-center.border-0.px-0.tz-quantity-input(type="number" name="quantity" value="1" min="1" max=product.stock)
                  .input-group-append
                    button.btn.btn-light.px-3.tz-quantity-btn(type="button" onclick="this.parentNode.previousElementSibling.stepUp()") +
              
              .d-flex.mt-4
                button.btn.d-flex.align-items-center.justify-content-center.mr-3.tz-btn-add-cart(type="submit")
                  i.fas.fa-cart-plus.mr-2
                  | THÊM VÀO GIỎ
                //- Nút MUA NGAY
                button.btn.d-flex.align-items-center.justify-content-center.tz-btn-buy-now(type="submit" name="buyNow" value="true")
                  | MUA NGAY
          else
            .mt-4
              button.btn.btn-secondary.w-100.tz-btn-out-stock(disabled)
                i.fas.fa-ban.mr-2
                | SẢN PHẨM HẾT HÀNG

    //- Description Section
    if product.description
      .card.border-0.shadow-sm.mb-5
        .card-header.bg-white.py-3.tz-card-header-light
          h5.mb-0.font-weight-bold.tz-card-title-md Đặc điểm nổi bật
        .card-body.p-3
          .tz-product-desc.content-html.tz-product-desc-content!= product.description

    //- Review Section
    .card.border-0.shadow-sm.mb-5.tz-review-section
      .card-header.bg-white.py-3.tz-card-header-light
        .d-flex.align-items-center.justify-content-between
          h5.mb-0.font-weight-bold.tz-card-title-md
            i.fas.fa-star.text-warning.mr-2
            | Đánh giá sản phẩm (#{reviewCount})
          if reviewCount > 0
            .tz-review-avg
              span.tz-review-avg-number= averageRating
              span.tz-review-avg-text /5
              .d-inline-flex.ml-2
                - for (var i = 1; i <= 5; i++)
                  if i <= Math.round(averageRating)
                    i.fas.fa-star.text-warning
                  else
                    i.fas.fa-star.text-muted

      .card-body.p-4
        //- Form đánh giá
        if canReview
          .tz-review-form.mb-4
            h6.font-weight-bold.mb-3
              i.fas.fa-pen.mr-2
              | Viết đánh giá của bạn
            form#reviewForm(data-product-id=product._id)
              .tz-star-rating.mb-3
                label.text-muted.mr-3 Chọn số sao:
                .tz-star-select
                  - for (var i = 1; i <= 5; i++)
                    i.fas.fa-star.tz-star-input(data-value=i)
                input(type="hidden" name="rating" id="ratingInput" value="5")
              .form-group.mb-3
                textarea.form-control.tz-review-textarea(name="comment" rows="3" placeholder="Chia sẻ trải nghiệm của bạn về sản phẩm này...")
              button.btn.tz-btn-submit-review(type="submit")
                i.fas.fa-paper-plane.mr-2
                | Gửi đánh giá

        else if hasReviewed
          .tz-review-notice.tz-review-notice-success.mb-4
            i.fas.fa-check-circle.mr-2
            | Bạn đã đánh giá sản phẩm này rồi. Cảm ơn bạn!

        else if !locals.clientUser
          .tz-review-notice.mb-4
            i.fas.fa-info-circle.mr-2
            | Vui lòng 
            a(href="/user/login") đăng nhập
            |  để đánh giá sản phẩm.

        else
          .tz-review-notice.mb-4
            i.fas.fa-shopping-bag.mr-2
            | Bạn cần mua sản phẩm này để có thể đánh giá.

        //- Danh sách đánh giá
        if reviews && reviews.length > 0
          .tz-review-list
            each review in reviews
              .tz-review-item
                .tz-review-item-header
                  .tz-review-avatar
                    if review.userAvatar
                      img(src=review.userAvatar alt=review.userName)
                    else
                      i.fas.fa-user-circle
                  .tz-review-info
                    .tz-review-name= review.userName
                    .d-flex.align-items-center
                      .tz-review-stars
                        - for (var i = 1; i <= 5; i++)
                          if i <= review.rating
                            i.fas.fa-star
                          else
                            i.fas.fa-star.text-muted
                      span.tz-review-date= review.createdAt.toLocaleDateString('vi-VN')
                if review.comment
                  .tz-review-comment= review.comment
        else
          .tz-review-empty
            i.fas.fa-comments
            p Chưa có đánh giá nào. Hãy là người đầu tiên đánh giá sản phẩm này!

  //- Script xử lý đánh giá
  script.
    // Star rating selection
    document.querySelectorAll('.tz-star-input').forEach(function(star) {
      star.addEventListener('click', function() {
        var value = parseInt(this.getAttribute('data-value'));
        document.getElementById('ratingInput').value = value;
        document.querySelectorAll('.tz-star-input').forEach(function(s, idx) {
          if (idx < value) {
            s.classList.add('active');
          } else {
            s.classList.remove('active');
          }
        });
      });

      star.addEventListener('mouseenter', function() {
        var value = parseInt(this.getAttribute('data-value'));
        document.querySelectorAll('.tz-star-input').forEach(function(s, idx) {
          if (idx < value) {
            s.classList.add('hover');
          } else {
            s.classList.remove('hover');
          }
        });
      });
    });

    // Reset hover on mouse leave
    var starSelect = document.querySelector('.tz-star-select');
    if (starSelect) {
      starSelect.addEventListener('mouseleave', function() {
        document.querySelectorAll('.tz-star-input').forEach(function(s) {
          s.classList.remove('hover');
        });
      });

      // Set default 5 stars active
      document.querySelectorAll('.tz-star-input').forEach(function(s) {
        s.classList.add('active');
      });
    }

    // Submit review via AJAX
    var reviewForm = document.getElementById('reviewForm');
    if (reviewForm) {
      reviewForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var productId = this.getAttribute('data-product-id');
        var rating = document.getElementById('ratingInput').value;
        var comment = this.querySelector('[name="comment"]').value;

        fetch('/reviews/' + productId, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ rating: rating, comment: comment })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.code === 200) {
            window.location.reload();
          } else {
            alert(data.message);
          }
        })
        .catch(function(err) {
          alert('Có lỗi xảy ra!');
        });
      });
    }
