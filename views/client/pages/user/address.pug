extends ../../layouts/default.pug

block main
  .container.my-5
    .row
      .col-12
        .d-flex.justify-content-between.align-items-center.mb-4
          h4.m-0.font-weight-bold.tz-text-dark Sổ Địa Chỉ
          a.btn.btn-primary.btn-sm(href=`/user/address/create${req.query.redirect ? '?redirect=checkout' : ''}`)
            i.fas.fa-plus.mr-2
            | Thêm Địa Chỉ

        if (addresses && addresses.length > 0)
          each addr in addresses
            .card.mb-3.border-0.shadow-sm(
              class=(req.query.selectedId === addr._id.toString() || (!req.query.selectedId && addr.isDefault)) ? "border-primary" : ""
              style=req.query.redirect === 'checkout' ? "cursor: pointer;" : ""
              onclick=req.query.redirect === 'checkout' ? `if(!event.target.closest('a') && !event.target.closest('button')) window.location.href='/cart/checkout?addressId=${addr._id}'` : ""
            )
              .card-body.p-3
                .row.align-items-center
                  .col-md-9
                    div.mb-2
                      span.font-weight-bold.tz-text-16-bold #{addr.fullName}
                      if addr.isDefault
                        span.badge.badge-primary.ml-2.tz-badge-default Mặc định
                    
                    div.text-muted.mb-1
                      i.fas.fa-phone.mr-2.tz-icon-blue
                      | #{addr.phone}
                    
                    div.text-muted
                      i.fas.fa-map-marker-alt.mr-2.tz-icon-blue
                      | #{addr.address}
                  
                  .col-md-3.text-right.mt-3.mt-md-0
                    //- Thao tác Chọn / Mặc định
                    .mb-2
                      if req.query.redirect === 'checkout'
                        // Luồng Chọn ở Giỏ Hàng
                        if req.query.selectedId !== addr._id.toString()
                          span.d-none
                        else
                          span.font-weight-bold.mr-2.tz-text-blue-14-bold 
                            i.fas.fa-check-circle.mr-1
                            | Đang chọn
                      else
                        // Luồng Quản lý thông thường
                        if !addr.isDefault
                          form(action=`/user/address/set-default/${addr._id}` method="POST" class="d-inline-block")
                            button.btn.btn-sm.btn-outline-primary.btn-tz-outline-blue Thiết lập mặc định
                        else
                          span.badge.badge-light.mr-2.tz-badge-light-blue Địa chỉ mặc định

                    //- Thao tác Sửa / Xóa
                    div.mt-3
                      a.mr-3.tz-link-blue-14(href=`/user/address/edit/${addr._id}${req.query.redirect ? "?redirect=checkout" : ""}`) Sửa
                      if !addr.isDefault
                        form(action=`/user/address/delete/${addr._id}` method="POST" class="d-inline-block form-delete-address")
                          button.btn.btn-link.text-danger.p-0.m-0.tz-btn-link-danger(type="submit") Xoá
        else
          .text-center.py-5.bg-white.rounded.shadow-sm
            i.fas.fa-map-marked-alt.fa-4x.text-muted.mb-3.tz-icon-muted-lg
            h6.mt-3.font-weight-bold Chưa có địa chỉ
            p.text-muted Vui lòng thêm địa chỉ nhận hàng của bạn
            
        //- Nút Thêm Địa Chỉ Cố Định (đã di chuyển lên trên)

  //- Script confirm xoá
  script.
    const formsDelete = document.querySelectorAll('.form-delete-address');
    if (formsDelete.length > 0) {
      formsDelete.forEach(form => {
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          if(confirm("Bạn có chắc chắn muốn xoá địa chỉ này?")) {
            form.submit();
          }
        });
      });
    }
